# Copyright (c) 2023-2025, NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import sys
import os

try:
    import skbuild
except ModuleNotFoundError as e:
    print(
        "!!!Pip version is 25.3 or higher enabled build isolation by default while the "
        "plugin requires no build isolation. Please pass the --no-build-isolation "
        "flag to pip install if that is the case!!!"
    )
    raise e

from packaging.version import Version, InvalidVersion
from packaging.requirements import Requirement
from importlib.metadata import distribution, PackageNotFoundError

def require(req_spec: str) -> None:
    r = Requirement(req_spec)
    try:
        dist = distribution(r.name)
    except PackageNotFoundError:
        print(f"Error: {req_spec} is required but not installed.")
        sys.exit(1)
    if r.specifier:
        try:
            installed = Version(dist.version)
        except InvalidVersion:
            print(f"Error: {req_spec} is required. Installed {r.name} has invalid version string: {dist.version!r}.")
            sys.exit(1)
        if not r.specifier.contains(installed):
            print(f"Error: {req_spec} is required. Found {dist.version}.")
            sys.exit(1)

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] != 'sdist':
        try:
            os.environ['DALI_PRELOAD_PLUGINS'] = ""  # no need to load plugins
            import nvidia.dali as dali
        except (ImportError, ModuleNotFoundError):
            installation_url = "https://docs.nvidia.com/deeplearning/dali/user-guide/docs/installation.html"
            print(f"Error: NVIDIA DALI is not available. Please install it and try again: {installation_url}")
            sys.exit(1)

        try:
            dali_ver = Version(dali.__version__)
            min_ver = Version('@DALI_VERSION@')
        except InvalidVersion as e:
            print(f"Error: Invalid DALI version string: {e}.")
            sys.exit(1)
        if dali_ver < min_ver:
            print(f"Error: At least NVIDIA DALI version @DALI_VERSION@ is required. Found version {dali.__version__}.")
            sys.exit(1)

        # For released packages, those dependencies should be pulled automatically at installation (via pyproject.toml)
        # However, for dev builds, we might want to build with --no-build-isolation so that we use the installed
        # version of DALI instead of a dependency from pip. For no-build-isolation, we expect the user to have
        # those installed.
        requirements = [
            "setuptools>=42",
            "scikit-build",
            "cmake>=3.25.2",
            "ninja"
        ]
        for req in requirements:
            require(req)

        os.environ["DALI_COMPILE_FLAGS"] = " ".join(dali.sysconfig.get_compile_flags())
        os.environ["DALI_LIB_DIR"] = dali.sysconfig.get_lib_dir()
        print("DALI include dir:", os.environ["DALI_COMPILE_FLAGS"])
        print("DALI lib dir:", os.environ["DALI_LIB_DIR"])

        os.environ["PYTHON_EXECUTABLE"] = sys.executable

    skbuild.setup(
        name="nvidia-dali-@DALI_PLUGIN_NAME@@DALI_FLAVOR_MINUS@",
        description="@DALI_PLUGIN_DESCRIPTION@. For NVIDIA DALI, @DALI_FLAVOR@. Git SHA: @GIT_SHA@",
        url='https://github.com/NVIDIA/DALI',
        version='@DALI_VERSION@',
        author='NVIDIA Corporation',
        license='Apache License 2.0',
        license_files=('LICENSE', 'COPYRIGHT', 'Acknowledgements.txt'),
        python_requires='>=3.10, <3.15',
        classifiers=[
            'Programming Language :: Python :: 3.10',
            'Programming Language :: Python :: 3.11',
            'Programming Language :: Python :: 3.12',
            'Programming Language :: Python :: 3.13',
            'Programming Language :: Python :: 3.14',
            ],
        include_package_data=True,
        extras_require={},
        packages=["nvidia/dali/plugin/@DALI_PLUGIN_NAME@"],
        package_dir={"": "src"},
        cmake_install_dir="src",
    )
